description: Rules related to requests (e.g. headers, params, bodies, security).
---
rules:
  request-get-has-body:
    description: |-
      GET requests should not specify a `requestBody`.

      # Incorrect
      {
        "/companies": {
          "get": {
            "requestBody": { ... }
          }
        }
      }

      # Incorrect Prism Highlight
      4

      # Correct
      {
        "/companies": {
          "get": { ... }
        }
      }

      # Correct Prism Highlight
      -
    severity: 'off'
    given: $.paths..get.requestBody
    then:
      function: falsy
  request-header-not-ref:
    description: |-
      Request headers must be specified using a `$ref`.

      # Incorrect
      {
        "headers": {
          "X-Custom-Header": {
            "schema": {
              "type": "string"
            },
            "description": "A custom header."
          }
        }
      }

      # Incorrect Prism Highlight
      4-7

      # Correct
      {
        "headers": {
          "X-Custom-Header": {
            "$ref": "../components/headers/x-custom-header.json"
          }
        }
      }

      # Correct Prism Highlight
      4
    given:
    - $..headers.*
    resolved: false
    severity: 'off'
    then:
    - field: $ref
      function: truthy
  request-header-not-ref-to-comp-dir:
    description: |-
      Request headers must be specified using a `$ref` to the `../components/headers` directory.

      # Incorrect
      {
        "headers": {
          "X-Custom-Header": {
            "$ref": "../some-path/headers/x-custom-header.json"
          }
        }
      }

      # Incorrect Prism Highlight
      4

      # Correct
      {
        "headers": {
          "X-Custom-Header": {
            "$ref": "../components/headers/x-custom-header.json"
          }
        }
      }

      # Correct Prism Highlight
      4
    given:
    - $..headers.*.$ref
    severity: 'off'
    then:
    - field: $ref
      function: pattern
      functionOptions:
        match: ^\\.\\.\/(components\/)?headers\/.*\\.json$
  request-missing-header-x-stplus-request-id:
    description: |-
      Paths must include the `X-STPlus-Request-Id` context header.

      # Incorrect
      {
        "headers": { ... }
      }

      # Incorrect Prism Highlight
      -

      # Correct
      {
        "headers": {
          "X-STPlus-Request-Id": { ... }
        }
      }

      # Correct Prism Highlight
      3
    severity: 'off'
    given:
    - $.*
    then:
      field: parameters
      function: schema
      functionOptions:
        schema:
          type: array
          contains:
            type: object
            properties:
              name:
                type: string
                pattern: ^X-STPlus-Request-Id$
              in:
                type: string
                pattern: ^header$
  request-missing-header-x-stplus-request-ip:
    description: |-
      Paths must include the `X-STPlus-Request-Ip` context header.

      # Incorrect
      {
        "headers": { ... }
      }

      # Incorrect Prism Highlight
      -

      # Correct
      {
        "headers": {
          "X-STPlus-Request-Ip": { ... }
        }
      }

      # Correct Prism Highlight
      3
    severity: 'off'
    given:
    - $.*
    then:
      field: parameters
      function: schema
      functionOptions:
        schema:
          type: array
          contains:
            type: object
            properties:
              name:
                type: string
                pattern: ^X-STPlus-Request-Ip$
              in:
                type: string
                pattern: ^header$
  request-missing-header-x-stplus-request-user-agent:
    description: |-
      Paths must include the `X-STPlus-Request-User-Agent` context header.

      # Incorrect
      {
        "headers": { ... }
      }

      # Incorrect Prism Highlight
      -

      # Correct
      {
        "headers": {
          "X-STPlus-Request-User-Agent": { ... }
        }
      }

      # Correct Prism Highlight
      3
    severity: 'off'
    given:
    - $.*
    then:
      field: parameters
      function: schema
      functionOptions:
        schema:
          type: array
          contains:
            type: object
            properties:
              name:
                type: string
                pattern: ^X-STPlus-Request-User-Agent$
              in:
                type: string
                pattern: ^header$
  request-missing-header-x-stplus-request-timezone:
    description: |-
      Paths must include the `X-STPlus-Request-Timezone` context header.

      # Incorrect
      {
        "headers": { ... }
      }

      # Incorrect Prism Highlight
      -

      # Correct
      {
        "headers": {
          "X-STPlus-Request-Timezone": { ... }
        }
      }

      # Correct Prism Highlight
      3
    severity: 'off'
    given:
    - $.*
    then:
      field: parameters
      function: schema
      functionOptions:
        schema:
          type: array
          contains:
            type: object
            properties:
              name:
                type: string
                pattern: ^X-STPlus-Request-Timezone$
              in:
                type: string
                pattern: ^header$
  request-missing-header-x-stplus-request-language:
    description: |-
      Paths must include the `X-STPlus-Request-Language` context header.

      # Incorrect
      {
        "headers": { ... }
      }

      # Incorrect Prism Highlight
      -

      # Correct
      {
        "headers": {
          "X-STPlus-Request-Language": { ... }
        }
      }

      # Correct Prism Highlight
      3
    severity: 'off'
    given:
    - $.*
    then:
      field: parameters
      function: schema
      functionOptions:
        schema:
          type: array
          contains:
            type: object
            properties:
              name:
                type: string
                pattern: ^X-STPlus-Request-Language$
              in:
                type: string
                pattern: ^header$
  request-security-missing-type-description:
    description: |-
      Security schemes must have a `type` and `description`.

      # Incorrect
      {
        "scheme": "bearer"
      }

      # Incorrect Prism Highlight
      -

      # Correct
      {
        "scheme": "bearer",
        "type": "http",
        "description": "A JWT.",
      }

      # Correct Prism Highlight
      3-4
    severity: 'off'
    given: $.
    then:
    - field: type
      function: truthy
    - field: description
      function: truthy
