<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectral Rules</title>

    <!-- Prism.js Styles -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-highlight/prism-line-highlight.min.css"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css"
        rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            margin: 0;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #f4f4f4;
            padding: 10px;
            overflow-y: auto;
            border-right: 1px solid #ccc;
        }

        .sidebar a {
            display: block;
            padding: 10px;
            text-decoration: none;
            color: #333;
            border-bottom: 1px solid #ddd;
        }

        .sidebar a:hover {
            background-color: #ddd;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .rule-title {
            font-weight: bold;
            font-size: 1.5em;
        }

        .rule-description {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .token.operator {
            background: transparent;
        }
    </style>
</head>

<body>
    <div class="sidebar" id="sidebar">
        <select id="fileSelect">
            <option value="">Select a file</option>
            <option value="method.yml">method.yml</option>
            <option value="naming.yml">naming.yml</option>
            <option value="response.yml">response.yml</option>
        </select>
    </div>
    <div class="content" id="content">
        <h1>Distributed Spectral Ruleset</h1>
        <p>This page displays the rules defined in this distributed Spectral ruleset. Select a file from the sidebar to
            view its rules.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
        const content = document.getElementById('content');
        const fileSelect = document.getElementById('fileSelect');

        fileSelect.addEventListener('change', async function () {
            const fileName = this.value;
            if (fileName) {
                try {
                    const cacheBuster = new Date().getTime();
                    const response = await fetch(`${fileName}?_=${cacheBuster}`);
                    const yamlText = await response.text();
                    const yamlData = jsyaml.load(yamlText);

                    const frontMatter = extractFrontMatter(yamlText);
                    displayFrontMatter(frontMatter);

                    injectExamples(yamlData.rules);
                    displayRules(yamlData.rules);
                } catch (error) {
                    content.innerHTML = `<div>Error loading file: ${error.message}</div>`;
                }
            } else {
                content.innerHTML = '<h1>Distributed Spectral Ruleset</h1><p>This page displays the rules defined in this distributed Spectral ruleset. Select a file from the sidebar to view its rules.</p>';
            }
        });

        function extractFrontMatter(yamlText) {
            // Match all comment lines after the '---' line and before the first non-comment line
            const frontMatterMatch = yamlText.match(/---\n((#.*\n)*)/);
            return frontMatterMatch ? frontMatterMatch[1].trim() : '';
        }

        function displayFrontMatter(frontMatter) {
            const frontMatterDiv = document.createElement('div');
            frontMatterDiv.className = 'front-matter';
            frontMatterDiv.innerHTML = `<pre>${frontMatter}</pre>`;
            content.innerHTML = ''; // Clear existing content
            content.appendChild(frontMatterDiv);
        }

        function injectExamples(rules) {
            if (!rules) return;

            for (const [key, rule] of Object.entries(rules)) {
                if (rule.description) {
                    const incorrectMatch = rule.description.match(/Incorrect:\s*```json\s*([\s\S]*?)\n```/);
                    const correctMatch = rule.description.match(/Correct:\s*```json\s*([\s\S]*?)\n```/);

                    if (incorrectMatch) {
                        rule.incorrect = incorrectMatch[1].trim();
                    }
                    if (correctMatch) {
                        rule.correct = correctMatch[1].trim();
                    }

                    // Remove the example sections from the description
                    rule.description = rule.description.replace(/Incorrect:\s*```json[\s\S]*?```/, '').replace(/Correct:\s*```json\s*.*?```/gs, '').trim();
                }
            }
        }

        function displayRules(rules) {
            if (!rules) {
                content.innerHTML += '<div>No rules found in the selected file.</div>';
                return;
            }

            for (const [title, rule] of Object.entries(rules)) {
                const ruleDiv = document.createElement('div');
                ruleDiv.innerHTML = `
                    <div class="rule-title">${title}</div>
                    <div class="rule-description">${rule.description || 'No description available.'}</div>
                    ${rule.incorrect ? `<div class="example-title">Incorrect:</div>
                        <div class="example">
                            <pre class="line-numbers"><code class="language-json">${rule.incorrect}</code></pre>
                        </div>` : ''}
                    ${rule.correct ? `<div class="example-title">Correct:</div>
                        <div class="example">
                            <pre class="line-numbers"><code class="language-json">${rule.correct}</code></pre>
                        </div>` : ''}
                `;

                // <div class="details">
                //   <div class="details-title">Code:</div>
                //   <pre>
                //   Severity: ${rule.severity || 'N/A'}
                //   Given: ${rule.given || 'N/A'}
                //   Then: ${JSON.stringify(rule.then, null, 2) || 'N/A'}
                //   </pre>
                // </div>

                content.appendChild(ruleDiv);
            }

            // Highlight all code blocks after they are added to the DOM
            Prism.highlightAll();
        }
    </script>

    <!-- Prism.js Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Copy to Clipboard Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

    <!-- Line Numbers Plugin -->
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

</body>

</html>